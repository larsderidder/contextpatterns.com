---
import { getCollection } from 'astro:content';
import Base from '../layouts/Base.astro';

function stripExt(id: string) {
  return id.replace(/\.md$/, '');
}

const allPatterns = (await getCollection('patterns')).sort((a, b) => a.data.order - b.data.order);
const problem = allPatterns.filter(p => p.data.category === 'problem');
const patterns = allPatterns.filter(p => p.data.category === 'pattern');
---

<Base title="Context Patterns — The discipline of designing what AI knows">
  <header class="hero">
    <div class="hero-label">The Discipline of Designing What AI Knows</div>
    <h1>Context Patterns</h1>

    <div class="stat-bar">
      <div class="stat">
        <div class="stat-number">+10.6%</div>
        <div class="stat-label">Agent benchmark improvement<br>with better context (Stanford/ACE)</div>
      </div>
      <div class="stat">
        <div class="stat-number">80%</div>
        <div class="stat-label">Fewer claim processing errors<br>with context engineering (Five Sigma)</div>
      </div>
      <div class="stat">
        <div class="stat-number">85%</div>
        <div class="stat-label">of models drop to half their<br>baseline at 32k tokens (NoLiMa)</div>
      </div>
    </div>
  </header>

  <section class="quote-section">
    <div class="big-quote">&ldquo;</div>
    <blockquote class="quote">
      <p>Context engineering is the delicate art and science of filling the context window with just the right information for the next step.</p>
      <footer class="author"><cite>Andrej Karpathy</cite></footer>
    </blockquote>
  </section>

  <main class="content">

    <hr class="section-rule">
    <h2>The Problem</h2>

    <div class="patterns">
      {problem.map((p) => (
        <a href={`/patterns/${stripExt(p.id)}`} class="pattern pattern-link">
          <div class="pattern-header">
            <div class={`pattern-dot dot-${p.data.dot}`}></div>
            <h3>{p.data.title}</h3>
          </div>
          <p>{p.data.summary}</p>
          <div class="source">
            {p.data.sources.map((s, i) => (
              <>
                {i > 0 && ', '}
                <span>{s.label}</span>
              </>
            ))}
          </div>
        </a>
      ))}
    </div>

    <hr class="section-rule" id="patterns">
    <h2>Patterns</h2>

    <div class="patterns">
      {patterns.map((p, i) => {
        const isInPair = (i === 0 || i === 2 || i === 4);
        const pairPartner = isInPair ? patterns[i + 1] : null;
        const isSecondInPair = (i === 1 || i === 3 || i === 5);

        if (isSecondInPair) return null;

        if (isInPair && pairPartner) {
          return (
            <div class="patterns-pair">
              <a href={`/patterns/${stripExt(p.id)}`} class="pattern pattern-link">
                <div class="pattern-header">
                  <div class={`pattern-dot dot-${p.data.dot}`}></div>
                  <h3>{p.data.title}</h3>
                </div>
                <p>{p.data.summary}</p>
                <div class="source">
                  {p.data.sources.map((s, j) => (
                    <>
                      {j > 0 && ', '}
                      <span>{s.label}</span>
                    </>
                  ))}
                </div>
              </a>
              <a href={`/patterns/${stripExt(pairPartner.id)}`} class="pattern pattern-link">
                <div class="pattern-header">
                  <div class={`pattern-dot dot-${pairPartner.data.dot}`}></div>
                  <h3>{pairPartner.data.title}</h3>
                </div>
                <p>{pairPartner.data.summary}</p>
                <div class="source">
                  {pairPartner.data.sources.map((s, j) => (
                    <>
                      {j > 0 && ', '}
                      <span>{s.label}</span>
                    </>
                  ))}
                </div>
              </a>
            </div>
          );
        }

        return (
          <a href={`/patterns/${stripExt(p.id)}`} class="pattern pattern-link">
            <div class="pattern-header">
              <div class={`pattern-dot dot-${p.data.dot}`}></div>
              <h3>{p.data.title}</h3>
            </div>
            <p>{p.data.summary}</p>
            <div class="source">
              {p.data.sources.map((s, j) => (
                <>
                  {j > 0 && ', '}
                  <span>{s.label}</span>
                </>
              ))}
            </div>
          </a>
        );
      })}
    </div>

    <hr class="section-rule" id="tools">
    <h2>Tools</h2>

    <div class="tool-card">
      <div class="tool-tag">Open Source</div>
      <h3>Context Lens</h3>
      <p>See what your AI actually sees. A framework-agnostic proxy that intercepts LLM API calls and visualizes context window composition. Works with Claude, GPT, and any tool that calls an LLM API.</p>
      <div class="source"><a href="https://github.com/larsderidder/context-lens" rel="noopener">github.com/larsderidder/context-lens</a></div>
    </div>

  </main>

  <section class="cta-section">
    <p class="cta-heading">Stay Current</p>
    <p>New patterns and research as they emerge. No spam, no noise.</p>
    <div class="tally-embed">
      <iframe data-tally-src="https://tally.so/embed/yP9lj4?alignLeft=1&hideDescription=1&transparentBackground=1&dynamicHeight=1" loading="lazy" width="100%" height="120" frameborder="0" marginheight="0" marginwidth="0" title="Stay in the loop"></iframe>
      <script is:inline>var d=document,w="https://tally.so/widgets/embed.js",v=function(){"undefined"!=typeof Tally?Tally.loadEmbeds():d.querySelectorAll("iframe[data-tally-src]:not([src])").forEach((function(e){e.src=e.dataset.tallySrc}))};if("undefined"!=typeof Tally)v();else if(d.querySelector('script[src="'+w+'"]')==null){var s=d.createElement("script");s.src=w;s.onload=v;s.onerror=v;d.body.appendChild(s)}</script>
    </div>
    <div class="links">
      <a href="https://github.com/larsderidder/context-lens" rel="noopener" class="primary">Context Lens on GitHub</a>
      <a href="https://linkedin.com/in/larsderidder" rel="noopener" class="secondary">LinkedIn</a>
      <a href="https://x.com/theredbeard_io" rel="noopener" class="secondary">X / Twitter</a>
    </div>
  </section>
</Base>

<style>
  /* ── Hero ── */

  .hero {
    max-width: 800px;
    margin: 0 auto;
    padding: 100px 48px 56px;
    text-align: center;
  }

  .hero-label {
    font-size: 0.8rem;
    font-weight: 600;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: var(--accent);
    margin-bottom: 24px;
  }

  h1 {
    font-family: 'Instrument Serif', serif;
    font-size: 3.5rem;
    font-weight: 400;
    line-height: 1.15;
    letter-spacing: -0.02em;
    color: var(--text);
    margin-bottom: 8px;
  }

  /* ── Stats ── */

  .stat-bar {
    display: flex;
    justify-content: center;
    gap: 0;
    margin-top: 40px;
    border-top: 1px solid var(--rule);
    border-bottom: 1px solid var(--rule);
  }

  .stat {
    flex: 1;
    max-width: 220px;
    padding: 28px 24px;
    text-align: center;
  }

  .stat + .stat {
    border-left: 1px solid var(--rule);
  }

  .stat-number {
    font-family: 'Instrument Serif', serif;
    font-size: 2.2rem;
    color: var(--text);
    line-height: 1.1;
  }

  .stat-label {
    font-size: 0.78rem;
    color: var(--text-secondary);
    margin-top: 8px;
    line-height: 1.5;
  }

  /* ── Quote ── */

  .quote-section {
    max-width: 680px;
    margin: 48px auto 64px;
    padding: 0 48px;
    position: relative;
  }

  .big-quote {
    font-family: 'Instrument Serif', serif;
    font-size: 5rem;
    color: var(--accent);
    opacity: 0.3;
    position: absolute;
    top: -20px;
    left: 24px;
    line-height: 1;
  }

  .quote p {
    font-family: 'Instrument Serif', serif;
    font-size: 1.4rem;
    font-style: italic;
    line-height: 1.6;
    color: var(--text-secondary);
  }

  .quote .author {
    margin-top: 16px;
    font-style: normal;
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--accent);
    text-align: left;
  }

  .quote .author cite { font-style: normal; }

  /* ── Content ── */

  .content {
    max-width: 800px;
    margin: 0 auto;
    padding: 0 48px;
  }

  .section-rule {
    border: none;
    border-top: 1px solid var(--rule);
    margin: 64px 0 48px;
  }

  h2 {
    font-size: 0.75rem;
    font-weight: 600;
    letter-spacing: 0.14em;
    text-transform: uppercase;
    color: var(--sage);
    margin-bottom: 32px;
    padding-bottom: 12px;
    border-bottom: 2px solid var(--sage);
    display: inline-block;
  }

  /* ── Pattern cards ── */

  .patterns {
    display: flex;
    flex-direction: column;
    gap: 14px;
  }

  .patterns-pair {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 14px;
  }

  .pattern {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 28px 28px 24px;
    transition: box-shadow 0.25s, border-color 0.25s, transform 0.25s;
  }

  .pattern:hover {
    border-color: var(--border-strong);
    box-shadow: var(--shadow-hover);
    transform: translateY(-1px);
  }

  .pattern-link {
    text-decoration: none;
    display: block;
    color: inherit;
  }

  .pattern-link:hover {
    text-decoration: none;
  }

  .pattern-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 10px;
  }

  .pattern-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    flex-shrink: 0;
  }

  .dot-gold { background: var(--accent); }
  .dot-blue { background: var(--blue); }

  .pattern h3 {
    font-family: 'Instrument Serif', serif;
    font-size: 1.35rem;
    font-weight: 400;
    color: var(--text);
    line-height: 1.3;
  }

  .pattern p {
    font-size: 0.95rem;
    color: var(--text-secondary);
    line-height: 1.7;
  }

  .source {
    margin-top: 10px;
    font-size: 0.8rem;
    color: var(--accent);
  }

  .source a {
    color: var(--accent);
    text-decoration: none;
    border-bottom: 1px solid transparent;
    transition: border-color 0.2s;
  }

  .source a:hover {
    border-bottom-color: var(--accent);
  }

  /* ── Tool card ── */

  .tool-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 28px;
    transition: box-shadow 0.25s, border-color 0.25s, transform 0.25s;
  }

  .tool-card:hover {
    border-color: var(--border-strong);
    box-shadow: var(--shadow-hover);
    transform: translateY(-1px);
  }

  .tool-tag {
    display: inline-block;
    background: var(--sage-light);
    color: var(--sage);
    font-size: 0.7rem;
    font-weight: 700;
    padding: 3px 10px;
    border-radius: 4px;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 14px;
  }

  .tool-card h3 {
    font-family: 'Instrument Serif', serif;
    font-size: 1.35rem;
    margin-bottom: 8px;
  }

  .tool-card p {
    font-size: 0.95rem;
    color: var(--text-secondary);
    line-height: 1.7;
  }

  /* ── CTA ── */

  .cta-section {
    max-width: 520px;
    margin: 80px auto 0;
    padding: 0 48px;
    text-align: center;
  }

  .cta-heading {
    font-family: 'Instrument Serif', serif;
    font-size: 2rem;
    font-weight: 400;
    color: var(--text);
    letter-spacing: -0.01em;
    margin-bottom: 12px;
  }

  .cta-section p:not(.cta-heading) {
    color: var(--text-secondary);
    font-size: 0.95rem;
    margin-bottom: 8px;
  }

  .tally-embed {
    margin: 0 auto 24px;
    max-width: 400px;
  }

  .links {
    display: flex;
    gap: 16px;
    justify-content: center;
    flex-wrap: wrap;
  }

  .links a {
    display: inline-block;
    padding: 10px 24px;
    border-radius: 6px;
    text-decoration: none;
    font-size: 0.9rem;
    font-weight: 600;
    transition: all 0.2s;
  }

  .links a:hover { text-decoration: none; }

  .links a.primary {
    background: var(--accent);
    color: white;
  }

  .links a.primary:hover {
    background: var(--accent-hover);
  }

  .links a.secondary {
    border: 1px solid var(--border);
    color: var(--text-secondary);
  }

  .links a.secondary:hover {
    border-color: var(--border-strong);
    color: var(--text);
  }

  /* ── Responsive ── */

  @media (max-width: 600px) {
    .hero { padding: 64px 24px 56px; }
    h1 { font-size: 2.4rem; }
    .stat-bar { flex-direction: column; }
    .stat { max-width: none; }
    .stat + .stat { border-left: none; border-top: 1px solid var(--rule); }
    .content { padding: 0 24px; }
    .patterns-pair { grid-template-columns: 1fr; }
    .quote-section { padding: 0 24px; }
    .big-quote { left: 8px; }
    .cta-section { padding: 0 24px; }
  }

  /* ── Print ── */

  @media print {
    .pattern, .tool-card { border-color: #ccc; background: #f9f9f9; }
    .pattern h3, .tool-card h3, h1 { color: black; }
    .pattern p, .tool-card p, .stat-label, .quote p { color: #333; }
    .stat-number { color: black; }
    .source a, .source span, .quote .author { color: #8B6914; }
    .links a.primary { background: #8B6914; }
    .links a.secondary { border-color: #ccc; color: black; }
  }

  @media (prefers-reduced-motion: reduce) {
    * { transition: none !important; transform: none !important; }
  }
</style>
